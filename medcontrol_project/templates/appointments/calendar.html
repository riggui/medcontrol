{% extends 'appointments/base.html' %}
{% load static %}
{% block content %}
<h2>Calendrier des créneaux disponibles</h2>
<div id="calendar"></div>

<!-- Toast container -->
<div id="toast-container" aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1060;"></div>

<!-- FullCalendar CSS & JS (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js"></script>

<script>
// CSRF helper (Django docs recommended)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function showToast(message, success=true, isHtml=false) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'simple-toast' + (success ? ' success' : ' error');
  if (isHtml) toast.innerHTML = message; else toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => { toast.classList.add('visible'); }, 10);
  setTimeout(() => {
    toast.classList.remove('visible');
    setTimeout(() => container.removeChild(toast), 500);
  }, 4000);
}

  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

    // injected by Django: whether the user is authenticated
    const userAuthenticated = {{ user_authenticated|yesno:"true,false" }};

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'fr',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: '{% url "appointments:creneaux_json" %}',
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        const ev = info.event;
        const when = ev.start ? ev.start.toLocaleString() : ev.startStr;
        if (!userAuthenticated) {
          showToast('⚠️ Vous devez être connecté pour réserver. <a href="/login/" style="text-decoration: underline; color: #333;">Se connecter</a>', false, true);
          return;
        }
        if (confirm(`Réserver ce créneau ?\n${ev.title}\n${when}`)) {
          fetch('{% url "appointments:api_reserver" 0 %}'.replace('/0/', '/' + ev.id + '/'), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({}),
          }).then(response => response.json().then(data => ({status: response.status, body: data})))
          .then(obj => {
            if (obj.status === 200 && obj.body.success) {
              showToast(obj.body.message, true);
              // remove event from calendar
              ev.remove();
            } else {
              const msg = obj.body && obj.body.message ? obj.body.message : 'Erreur lors de la réservation.';
              showToast(msg, false);
            }
          }).catch(err => {
            console.error('Fetch error', err);
            showToast('Erreur réseau pendant la réservation.', false);
          });
        }
      },
      displayEventTime: true,
      navLinks: true,
    });

    calendar.render();
  });
</script>

<style>
  #calendar { max-width: 900px; margin: 20px auto; }

  /* Minimalistic toast styles */
  #toast-container .simple-toast {
    min-width: 200px;
    margin-top: 8px;
    padding: 10px 14px;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    opacity: 0;
    transform: translateY(-8px);
    transition: opacity 0.25s ease, transform 0.25s ease;
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    font-size: 14px;
    background: white;
    color: #111;
    border-left: 4px solid transparent;
  }
  #toast-container .simple-toast.visible { opacity: 1; transform: translateY(0); }
  #toast-container .simple-toast.success { border-left-color: #22c55e; }
  #toast-container .simple-toast.error { border-left-color: #ef4444; }
</style>

{% endblock %}
